# captcha letitbit.net - распознавание
# - на входе:  $url_captcha - url картинки
# - на выходе: $captcha     - символы каптчи
#
# by Serg0 [15.02.2010]

MAX_cTRY=3  # число попыток распознать
TEMP_CAPTCHA=$TEMP_HTML.captcha  # имя для временных файлов
PATTERNS_FILE=$PLUGINS_DIR/letitbit.net.captcha.sh  # файл с образцами символов

captcha=""
cTry=0
while [ ${#captcha} -lt 6  -a  $cTry -lt $MAX_cTRY ]; do
  cTry=$(($cTry+1))

  # скачаем картинку
  $WGETBIN "$url_captcha" -O "$TEMP_CAPTCHA.jpg" --quiet
  # wget.error ?
  if [ "$?" != "0" ] ;  then log "captcha: wget.ERROR"; continue; fi

  # jpg --> bmp
  djpeg -bmp -grayscale -colors 64 "$TEMP_CAPTCHA.jpg" >"$TEMP_CAPTCHA.bmp"
  # djpeg.error ?
  if [ "$?" != "0" ] ;  then log "captcha: djpeg.ERROR"; continue; fi

  # bmp --> txt
  tail -c 1344 "$TEMP_CAPTCHA.bmp" | tr "'-z" "." | tr -c "." "@" >"$TEMP_CAPTCHA.txt"

  # составим битовые карты символов
  awk '{ ORS=""
for( N=0; N<6; N++ ) {
  print ":" >(outFile"."N)
  for( r=1; r<=19; r++ ) {
    line= substr($0, (64*r)+(9*N)+3, 8)
    if( line != "........" )  print line >(outFile"."N)
    } # for r
  close(outFile"."N)
  } # for N
exit
}' outFile="$TEMP_CAPTCHA.char" "$TEMP_CAPTCHA.txt"

  # переберЄм 6 символов каптчи
  captcha=""
  for N in 0 1 2 3 4 5; do
    # поищем символ в образцах
    char=$( grep -F -f "$TEMP_CAPTCHA.char.$N" "$PATTERNS_FILE" | head -c1 )
    if [ "$char" = "" ]; then break; fi  # если не нашли, то бросаем эту катпчу
    # допишем символ в каптчу
    captcha=${captcha}$char
  done # for 6 chars

done # while cTry

rm "$TEMP_CAPTCHA".* 2>/dev/null  # удалим временные файлы

test ${#captcha} -eq 6
return $?

#---------------------------------------------------------------------------------
# patterns:
0:...@@.....@..@...@....@..@....@..@....@..@....@..@....@..@....@...@..@.....@@...
0:...@@.....@@@@...@@..@@.@@....@@@@....@@@@....@@@@....@@.@@..@@...@@@@.....@@...
0:.@@@@...@@..@@..@@..@@..@@@.@@..@@.@@@..@@..@@..@@..@@...@@@@...
1:..@@@@@.....@.......@.......@.......@.......@.......@.....@.@......@@.......@...
1:.@@@@@@....@@......@@......@@......@@......@@......@@....@@@@.....@@@......@@...
1:@@@@@@....@@......@@......@@......@@....@.@@.....@@@......@@....
2:.@@@@@@..@.......@........@........@........@@........@..@....@..@....@...@@@@..
2:@@@@@@..@@.......@@.......@@@.......@@..@@..@@..@@..@@...@@@@...
2:@@@@@@@@.@@.......@@.......@@.......@@.......@@.......@@@@....@@.@@..@@...@@@@..
3:..@@@@...@....@..@....@.......@.......@....@@@........@..@....@..@....@...@@@@..
3:.@@@@...@@..@@......@@......@@...@@@@.......@@..@@..@@...@@@@...
3:.@@@@@..@@...@@.......@@......@@.....@@....@@@.......@@.......@@@@...@@..@@@@@..
4:.....@.......@.......@...@@@@@@..@...@...@...@....@..@.....@.@......@@.......@..
4:.....@@......@@......@@.@@@@@@@@@@...@@..@@..@@...@@.@@....@@@@.....@@@......@@.
4:....@@......@@..@@@@@@..@@..@@...@@.@@....@@@@.....@@@......@@..
5:..@@@@...@....@.......@.......@.......@..@@@@@...@.......@.......@.......@@@@@@.
5:..@@@@...@@..@@.@@....@@......@@......@@@@@..@@.@@.@@@..@@......@@......@@@@@@@.
5:.@@@@...@@..@@......@@......@@..@@..@@..@@@@@...@@......@@@@@@..
6:..@@@@...@....@..@....@..@....@..@....@..@@@@@...@.......@........@........@@@..
6:..@@@@...@@..@@.@@....@@@@....@@@@@..@@.@@.@@@..@@......@@....@..@@..@@...@@@@..
6:.@@@@...@@..@@..@@..@@..@@..@@..@@@@@...@@......@@..@@...@@@@...
7:....@.......@.......@.......@........@.......@.......@........@.......@..@@@@@@.
7:.@@......@@.......@@......@@.......@@......@@.......@@..@@@@@@..
7:@@......@@.......@@.......@@.......@@.......@@.......@@.......@@......@@@@@@@@@@
8:..@@@@...@....@..@....@..@....@..@....@...@@@@...@....@..@....@..@....@...@@@@..
8:..@@@@...@@..@@.@@....@@@@....@@.@@..@@...@@@@...@@..@@.@@....@@.@@..@@...@@@@..
8:.@@@@...@@..@@..@@..@@..@@..@@...@@@@...@@..@@..@@..@@...@@@@...
9:..@@@........@........@.......@.......@...@@@@@..@....@..@....@..@....@...@@@@..
9:..@@@@...@@..@@..@....@@......@@..@@@.@@.@@..@@@@@....@@@@....@@.@@..@@...@@@@..
9:.@@@@...@@..@@......@@...@@@@@..@@..@@..@@..@@..@@..@@...@@@@...
a:..@@@.@..@...@@..@....@...@@..@.....@@@..@....@...@@@@..
a:.@@@@.@@@@...@@@@@....@@.@@@@@@@......@@.@@...@@..@@@@@.
a:.@@@@@..@@..@@..@@..@@...@@@@@......@@...@@@@...
b:.@.@@@...@@...@..@....@..@....@..@....@..@@...@..@.@@@...@.......@.......@......
b:@@.@@@..@@@..@@.@@....@@@@....@@@@....@@@@@..@@.@@.@@@..@@......@@......@@......
b:@@@@@...@@..@@..@@..@@..@@..@@..@@..@@..@@@@@...@@......@@......@@......
c:..@@@@...@....@..@.......@.......@.......@....@...@@@@..
c:..@@@@@..@@...@@@@......@@......@@.......@@...@@..@@@@@.
c:.@@@@...@@..@@..@@......@@......@@..@@...@@@@...
d:..@@@.@..@...@@..@....@..@....@..@....@..@...@@...@@@.@.......@.......@.......@.
d:..@@@.@@.@@..@@@@@....@@@@....@@@@....@@.@@..@@@..@@@.@@......@@......@@......@@
d:.@@@@@..@@..@@..@@..@@..@@..@@..@@..@@...@@@@@......@@......@@......@@..
e:..@@@@...@.......@.......@@@@@@..@....@..@....@...@@@@..
e:..@@@@@..@@...@@@@......@@@@@@@@@@....@@.@@..@@...@@@@..
e:.@@@@...@@..@@..@@......@@@@@@..@@..@@...@@@@...
f:..@.......@.......@.......@.......@......@@@@@....@.......@.......@...@....@@@..
f:..@@......@@......@@......@@....@@@@@@....@@......@@......@@..@@..@@..@@...@@@@.
f:.@@......@@......@@......@@.....@@@@.....@@......@@......@@.@@....@@@...
